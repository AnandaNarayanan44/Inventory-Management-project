{% extends 'base.html' %}

{% block body %}

<div class="form-container">
    <div class="form-card">
        <!-- Form Header -->
        <div class="form-header">
            <i class="fas fa-minus-circle"></i>
            <h1>Reduce Stock</h1>
            <p>Record sales or remove stock from inventory</p>
        </div>

        <!-- Form Body -->
        <div class="form-body">
            <!-- Success/Error Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}exclamation-circle{% endif %}"></i>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" action="{% url 'reduceStock' %}" id="reduceStockForm">
                {% csrf_token %}
                
                <!-- Product Selection Section -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-box"></i>
                        Product & Location
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="product">
                            <i class="fas fa-cube"></i>
                            Select Product
                            <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <i class="fas fa-box-open input-icon"></i>
                            <select class="form-select" id="product" name="product" required>
                                <option value="">Choose a product...</option>
                                {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="helper-text">
                            <i class="fas fa-info-circle"></i>
                            Select the product to reduce stock for
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="warehouse">
                            <i class="fas fa-warehouse"></i>
                            Warehouse Location
                            <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <i class="fas fa-map-marker-alt input-icon"></i>
                            <select class="form-select" id="warehouse" name="warehouse" required>
                                <option value="">Select warehouse...</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse.id }}">{{ warehouse.name }} - {{ warehouse.location }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="helper-text">
                            <i class="fas fa-info-circle"></i>
                            Choose the warehouse where stock will be reduced
                        </div>
                    </div>

                    <!-- Current Stock Info (shown dynamically) -->
                    <div class="stock-info-card" id="stockInfoCard">
                        <div class="stock-info-row">
                            <span class="stock-info-label">Current Stock Level:</span>
                            <span class="stock-info-value" id="currentStock">--</span>
                        </div>
                        <div class="stock-info-row">
                            <span class="stock-info-label">After Reduction:</span>
                            <span class="stock-info-value" id="afterStock">--</span>
                        </div>
                    </div>
                </div>

                <!-- Sale Details Section -->
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-shopping-cart"></i>
                        Sale Details
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="quantity">
                                <i class="fas fa-hashtag"></i>
                                Quantity Sold
                                <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <i class="fas fa-boxes input-icon"></i>
                                <input type="number" 
                                       class="form-control" 
                                       id="quantity" 
                                       name="quantity" 
                                       min="1"
                                       placeholder="Enter quantity" 
                                       required />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="sale_price">
                                <i class="fas fa-dollar-sign"></i>
                                Sale Price (â‚¹)
                            </label>
                            <div class="input-group">
                                <i class="fas fa-indian-rupee-sign input-icon"></i>
                                <input type="number" 
                                       class="form-control" 
                                       id="sale_price" 
                                       name="sale_price" 
                                       step="0.01"
                                       min="0"
                                       placeholder="0.00" />
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="customer_name">
                                <i class="fas fa-user"></i>
                                Customer Name
                            </label>
                            <div class="input-group">
                                <i class="fas fa-user-circle input-icon"></i>
                                <input type="text" 
                                       class="form-control" 
                                       id="customer_name" 
                                       name="customer_name" 
                                       placeholder="Enter customer name" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="sale_date">
                                <i class="fas fa-calendar"></i>
                                Sale Date
                                <span class="required">*</span>
                            </label>
                            <div class="input-group">
                                <i class="fas fa-calendar-day input-icon"></i>
                                <input type="date" 
                                       class="form-control" 
                                       id="sale_date" 
                                       name="sale_date" 
                                       required />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="reason">
                            <i class="fas fa-clipboard"></i>
                            Reason for Reduction
                            <span class="required">*</span>
                        </label>
                        <div class="input-group">
                            <i class="fas fa-list input-icon"></i>
                            <select class="form-select" id="reason" name="reason" required>
                                <option value="">Select reason...</option>
                                <option value="sale">Sale</option>
                                <option value="damage">Damage</option>
                                <option value="expired">Expired</option>
                                <option value="theft">Theft</option>
                                <option value="return">Return to Supplier</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="notes">
                            <i class="fas fa-sticky-note"></i>
                            Additional Notes
                        </label>
                        <textarea class="form-control" 
                                  id="notes" 
                                  name="notes" 
                                  rows="3"
                                  placeholder="Add any additional remarks..."></textarea>
                        <div class="helper-text">
                            <i class="fas fa-info-circle"></i>
                            Optional notes about this stock reduction
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <a href="{% url 'inventory' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        Reduce Stock
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('sale_date').value = today;

    // Form validation feedback
    document.getElementById('reduceStockForm').addEventListener('submit', function(e) {
        const form = e.target;
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
            
            // Highlight invalid fields
            const invalidFields = form.querySelectorAll(':invalid');
            invalidFields.forEach(field => {
                field.style.borderColor = 'var(--danger-color)';
            });
        }
    });

    // Remove error styling on input
    document.querySelectorAll('.form-control, .form-select').forEach(input => {
        input.addEventListener('input', function() {
            this.style.borderColor = '';
        });
    });

    // Show/hide stock info card (you can enhance this with AJAX)
    const productSelect = document.getElementById('product');
    const warehouseSelect = document.getElementById('warehouse');
    const stockInfoCard = document.getElementById('stockInfoCard');
    const quantityInput = document.getElementById('quantity');

    function updateStockInfo() {
        if (productSelect.value && warehouseSelect.value) {
            // This is a placeholder - in production, fetch real data via AJAX
            stockInfoCard.classList.add('show');
            document.getElementById('currentStock').textContent = '100 units';
            
            // Update after stock based on quantity
            const quantity = parseInt(quantityInput.value) || 0;
            const afterValue = Math.max(0, 100 - quantity);
            const afterStockEl = document.getElementById('afterStock');
            afterStockEl.textContent = afterValue + ' units';
            
            // Update color based on level
            afterStockEl.classList.remove('low', 'out');
            if (afterValue === 0) {
                afterStockEl.classList.add('out');
            } else if (afterValue < 20) {
                afterStockEl.classList.add('low');
            }
        } else {
            stockInfoCard.classList.remove('show');
        }
    }

    productSelect.addEventListener('change', updateStockInfo);
    warehouseSelect.addEventListener('change', updateStockInfo);
    quantityInput.addEventListener('input', updateStockInfo);
</script>

{% endblock body %}